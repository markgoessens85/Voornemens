<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voornemens ‚Ä¢ Dagtracker</title>

  <!-- iOS: openen als web-app vanaf beginscherm -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Voornemens">

  <style>
    :root{
      --bg:#070b14;
      --panel:#121b2f;
      --panel2:#0f172a;
      --text:#eaf0ff;
      --muted:#a8b6d6;
      --line:rgba(255,255,255,.10);
      --good:#51e3a4;
      --warn:#ffd166;
      --bad:#ff6b6b;
      --accent:#7aa2ff;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius:14px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(122,162,255,.20), transparent 55%),
                  radial-gradient(900px 700px at 90% 0%, rgba(81,227,164,.16), transparent 55%),
                  linear-gradient(180deg, #050814, var(--bg) 35%, #070b14);
      color:var(--text);
    }

    .wrap{ max-width: 1100px; margin: 0 auto; padding: 16px; }
    header{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin: 6px 0 14px;
    }
    h1{ font-size: 20px; margin:0; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:13px; margin-top:4px; }

    .grid{ display:grid; grid-template-columns: 380px 1fr; gap: 14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: rgba(18,27,47,.92);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    .card .bd{ padding: 12px 14px; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row.nowrap{ flex-wrap:nowrap; }
    .spacer{ flex:1; }

    input, button, select, textarea{
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }
    textarea{ width:100%; min-height: 90px; resize: vertical; }
    input[type="date"], input[type="time"]{ padding: 9px 12px; }
    input::placeholder, textarea::placeholder{ color: rgba(168,182,214,.75); }

    button{
      cursor:pointer;
      user-select:none;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      font-weight: 650;
    }
    button.primary{
      background: rgba(122,162,255,.18);
      border-color: rgba(122,162,255,.35);
    }
    button.danger{
      background: rgba(255,107,107,.12);
      border-color: rgba(255,107,107,.35);
    }
    button.ghost{
      background: transparent;
      border-color: rgba(255,255,255,.12);
    }
    button:active{ transform: translateY(1px); }

    .pill{
      font-size: 12px;
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }

    .muted{ color:var(--muted); font-size: 13px; }
    .small{ font-size: 12px; color: var(--muted); }

    .goalList{ display:flex; flex-direction:column; gap:10px; }
    .goal{
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .goal .left{ min-width:0; }
    .goal .name{
      font-weight: 750;
      font-size: 14px;
      line-height: 1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .goal .meta{ margin-top:4px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .colorDot{
      width:10px; height:10px; border-radius:999px;
      display:inline-block;
      border: 1px solid rgba(255,255,255,.35);
      flex:0 0 auto;
    }
    .scoreInput{
      width: 86px;
      text-align:center;
      font-weight: 800;
      font-size: 16px;
      padding: 10px 10px;
    }
    .iconBtn{
      padding: 9px 10px;
      border-radius: 12px;
      min-width: 40px;
    }

    .hr{ height:1px; background: rgba(255,255,255,.08); margin: 12px 0; }

    /* chart */
    .chartWrap{
      width: 100%;
      padding: 10px 0 4px;
    }
    canvas{ width: 100%; height: 420px; display:block; }
    @media (max-width: 980px){ canvas{ height: 360px; } }

    .legend{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top: 8px;
    }
    .legendItem{
      display:flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: var(--muted);
    }

    .avgGrid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    @media (max-width: 520px){ .avgGrid{ grid-template-columns: 1fr; } }

    .avgItem{
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px;
    }
    .avgItem .top{ display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .avgItem .title{ font-weight: 800; font-size: 13px; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .avgItem .pct{ font-size: 18px; font-weight: 900; letter-spacing:.2px; }
    .avgItem .sub{ margin-top: 6px; font-size: 12px; color: var(--muted); }

    .banner{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      margin: 10px 0 14px;
      display:none;
    }
    .banner.show{ display:block; }
    .banner.good{ border-color: rgba(81,227,164,.35); background: rgba(81,227,164,.10); }
    .banner.warn{ border-color: rgba(255,209,102,.35); background: rgba(255,209,102,.10); }
    .banner.bad{ border-color: rgba(255,107,107,.35); background: rgba(255,107,107,.10); }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New";
      font-size: 12px;
      padding: 3px 7px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      white-space:nowrap;
    }

    .modalBg{
      position: fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding: 16px;
      z-index: 999;
    }
    .modalBg.show{ display:flex; }
    .modal{
      width: min(520px, 100%);
      border-radius: 16px;
      background: rgba(18,27,47,.98);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .mhd{ padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,.08); display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .modal .mbd{ padding: 12px 14px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Voornemens</h1>
        <div class="sub">Elke dag scoren, notities bijhouden, progressie zien in √©√©n grafiek.</div>
      </div>
      <div class="row">
        <span class="pill" id="streakPill">Streak: ‚Äî</span>
        <span class="pill" id="todayPill">Vandaag: ‚Äî</span>
      </div>
    </header>

    <div class="banner" id="banner"></div>

    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <div class="hd">
          <div style="font-weight:800;">Vandaag invullen</div>
          <button class="ghost iconBtn" id="openSettingsBtn" title="Instellingen">‚öôÔ∏è</button>
        </div>
        <div class="bd">
          <div class="row">
            <input id="newGoal" placeholder="Nieuw voornemen (bv. 30 min bewegen)" style="flex:1; min-width: 220px;">
            <button class="primary" id="addGoalBtn">Toevoegen</button>
          </div>
          <div class="small" style="margin-top:8px;">
            Tip: geef een cijfer <span class="kbd">0‚Äì10</span>. Dit wordt automatisch omgezet naar percentage voor gemiddelden.
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="row nowrap">
              <button class="ghost iconBtn" id="prevDayBtn" title="Vorige dag">‚óÄÔ∏é</button>
              <input type="date" id="datePick">
              <button class="ghost iconBtn" id="nextDayBtn" title="Volgende dag">‚ñ∂Ô∏é</button>
            </div>
            <button class="ghost" id="todayBtn">Vandaag</button>
            <div class="spacer"></div>
            <button class="ghost" id="clearDayBtn" title="Scores van deze dag wissen">Dag leegmaken</button>
          </div>

          <div class="goalList" id="goalsList" style="margin-top: 12px;"></div>

          <div class="hr"></div>

          <div style="font-weight:800; margin-bottom:8px;">Notitie voor deze dag</div>
          <textarea id="dayNote" placeholder="Bijv. wat ging goed, wat was lastig, wat wil je morgen anders doen‚Ä¶"></textarea>
          <div class="row" style="margin-top: 10px;">
            <button class="primary" id="saveNoteBtn">Notitie opslaan</button>
            <div class="spacer"></div>
            <button id="exportBtn">Export</button>
            <button id="importBtn">Import</button>
            <button class="danger" id="resetBtn">Reset alles</button>
            <input id="fileInput" type="file" accept="application/json" style="display:none" />
          </div>
          <div class="small" style="margin-top: 8px;">
            Export/Import is handig als back-up of als je van telefoon wisselt.
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <div class="hd">
          <div>
            <div style="font-weight:800;">Voortgang</div>
            <div class="muted">Alles samen in √©√©n grafiek (y=0‚Äì10, x=datum).</div>
          </div>
          <div class="row">
            <span class="muted">Periode</span>
            <select id="rangeSelect">
              <option value="30">Laatste 30 dagen</option>
              <option value="90">Laatste 90 dagen</option>
              <option value="365">Laatste 365 dagen</option>
              <option value="all">Alles</option>
            </select>
          </div>
        </div>
        <div class="bd">
          <div class="chartWrap">
            <canvas id="chart" width="1100" height="520"></canvas>
          </div>
          <div class="legend" id="legend"></div>

          <div class="hr"></div>

          <div style="font-weight:800;">Gemiddelde per voornemen</div>
          <div class="avgGrid" id="avgGrid"></div>
        </div>
      </section>
    </div>
  </div>

  <!-- Settings modal -->
  <div class="modalBg" id="settingsBg" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mhd">
        <div style="font-weight:900;">Instellingen</div>
        <button class="ghost iconBtn" id="closeSettingsBtn" title="Sluiten">‚úï</button>
      </div>
      <div class="mbd">
        <div class="row" style="align-items:flex-start;">
          <div style="flex:1; min-width: 240px;">
            <div style="font-weight:800; margin-bottom:6px;">Dagelijkse herinnering (in-app)</div>
            <div class="small">
              iPhone laat in een los HTML-bestand geen echte push-notificaties toe.
              Dit is een ‚Äúin-app‚Äù herinnering: zodra je de app opent na het ingestelde tijdstip en je hebt vandaag nog niet gescoord, zie je een reminder-banner.
            </div>
          </div>
          <div style="flex:0 0 auto;">
            <label class="small" style="display:block; margin-bottom:6px;">Tijd</label>
            <input type="time" id="reminderTime" value="20:00">
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <label class="row nowrap" style="gap:10px;">
            <input type="checkbox" id="reminderEnabled" style="transform: scale(1.25);">
            <span style="font-weight:800;">Herinnering aan</span>
          </label>
          <div class="spacer"></div>
          <button class="primary" id="saveSettingsBtn">Opslaan</button>
        </div>

        <div class="hr"></div>

        <div style="font-weight:800; margin-bottom:6px;">Schaal / interpretatie</div>
        <div class="small">
          Score 0‚Äì10 ‚Üí percentage = score/10 √ó 100.
          Lege velden tellen niet mee in het gemiddelde.
        </div>

        <div class="hr"></div>

        <div style="font-weight:800; margin-bottom:6px;">Tip voor echte notificaties</div>
        <div class="small">
          Wil je w√©l echte reminders op iPhone? Maak een herhaalde herinnering in de Apple <b>Herinneringen</b>-app of <b>Agenda</b>.
          (Deze tracker blijft dan gewoon √©√©n bestand.)
        </div>
      </div>
    </div>
  </div>

<script>
/* ===========================
   DATA & STORAGE
=========================== */
const KEY = "voornemens.singlefile.v2";
const PALETTE = ["#7aa2ff","#51e3a4","#ffd166","#ff6b6b","#b794f4","#22d3ee","#f472b6","#a3e635","#fb923c","#60a5fa"];

const defaultState = {
  goals: [],                 // [{id,name,color}]
  days: {},                  // { "YYYY-MM-DD": { scores: {goalId: number}, note: string } }
  settings: { reminderEnabled: true, reminderTime: "20:00" }
};

function loadState(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return structuredClone(defaultState);
    const s = JSON.parse(raw);
    // basic shape guard
    if(!s || typeof s !== "object") return structuredClone(defaultState);
    s.goals ??= [];
    s.days ??= {};
    s.settings ??= structuredClone(defaultState.settings);
    return s;
  }catch{
    return structuredClone(defaultState);
  }
}
function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }

let state = loadState();

const qs = (sel)=>document.querySelector(sel);
const el = (id)=>document.getElementById(id);

const newGoalEl = el("newGoal");
const addGoalBtn = el("addGoalBtn");
const goalsListEl = el("goalsList");
const datePickEl = el("datePick");
const prevDayBtn = el("prevDayBtn");
const nextDayBtn = el("nextDayBtn");
const todayBtn = el("todayBtn");
const clearDayBtn = el("clearDayBtn");
const dayNoteEl = el("dayNote");
const saveNoteBtn = el("saveNoteBtn");

const exportBtn = el("exportBtn");
const importBtn = el("importBtn");
const resetBtn = el("resetBtn");
const fileInput = el("fileInput");

const rangeSelectEl = el("rangeSelect");
const avgGridEl = el("avgGrid");
const legendEl = el("legend");
const bannerEl = el("banner");
const streakPill = el("streakPill");
const todayPill = el("todayPill");

const settingsBg = el("settingsBg");
const openSettingsBtn = el("openSettingsBtn");
const closeSettingsBtn = el("closeSettingsBtn");
const saveSettingsBtn = el("saveSettingsBtn");
const reminderEnabledEl = el("reminderEnabled");
const reminderTimeEl = el("reminderTime");

function isoToday(){
  const d = new Date();
  // ensure local date in ISO (not UTC)
  const tz = d.getTimezoneOffset();
  const local = new Date(d.getTime() - tz*60000);
  return local.toISOString().slice(0,10);
}
function addDays(iso, delta){
  const d = new Date(iso + "T00:00:00");
  d.setDate(d.getDate() + delta);
  return d.toISOString().slice(0,10);
}
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function escHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function ensureDay(dateISO){
  if(!state.days[dateISO]) state.days[dateISO] = { scores: {}, note: "" };
  if(!state.days[dateISO].scores) state.days[dateISO].scores = {};
  if(typeof state.days[dateISO].note !== "string") state.days[dateISO].note = "";
}
function getGoalColor(idx){ return PALETTE[idx % PALETTE.length]; }

if(!datePickEl.value) datePickEl.value = isoToday();

/* ===========================
   GOALS
=========================== */
function addGoal(){
  const name = (newGoalEl.value || "").trim();
  if(!name) return;
  const id = (crypto?.randomUUID?.() || ("g_" + Math.random().toString(16).slice(2)));
  const color = getGoalColor(state.goals.length);
  state.goals.push({ id, name, color });
  newGoalEl.value = "";
  saveState();
  renderAll();
}
function removeGoal(id){
  state.goals = state.goals.filter(g => g.id !== id);
  // remove scores referencing this goal
  for(const d of Object.keys(state.days)){
    if(state.days[d]?.scores && state.days[d].scores[id] != null) delete state.days[d].scores[id];
  }
  saveState();
  renderAll();
}
function renameGoal(id, newName){
  const g = state.goals.find(x => x.id === id);
  if(!g) return;
  g.name = newName.trim().slice(0, 80) || g.name;
  saveState();
  renderAll();
}

/* ===========================
   SCORING + NOTES
=========================== */
function setScore(dateISO, goalId, raw){
  ensureDay(dateISO);
  if(raw === "" || raw == null){
    delete state.days[dateISO].scores[goalId];
  }else{
    const v = clamp(Number(raw), 0, 10);
    state.days[dateISO].scores[goalId] = v;
  }
  saveState();
  renderHeaderBadges();
  renderBanner();
  drawChart();
  renderAverages();
}
function saveNoteForDay(dateISO){
  ensureDay(dateISO);
  state.days[dateISO].note = (dayNoteEl.value || "").trim();
  saveState();
  flashBanner("Notitie opgeslagen ‚úÖ", "good", 1500);
}
function clearDay(dateISO){
  if(!confirm("Scores en notitie voor deze dag wissen?")) return;
  ensureDay(dateISO);
  state.days[dateISO].scores = {};
  state.days[dateISO].note = "";
  saveState();
  renderAll();
}

/* ===========================
   DATE NAV
=========================== */
function goToDate(dateISO){
  datePickEl.value = dateISO;
  renderDay();
}
prevDayBtn.onclick = ()=>goToDate(addDays(datePickEl.value || isoToday(), -1));
nextDayBtn.onclick = ()=>goToDate(addDays(datePickEl.value || isoToday(), +1));
todayBtn.onclick   = ()=>goToDate(isoToday());
datePickEl.onchange= ()=>renderDay();
clearDayBtn.onclick= ()=>clearDay(datePickEl.value || isoToday());

/* ===========================
   SETTINGS (in-app reminders)
=========================== */
openSettingsBtn.onclick = ()=>{ openSettings(); };
closeSettingsBtn.onclick= ()=>{ closeSettings(); };
settingsBg.addEventListener("click", (e)=>{ if(e.target === settingsBg) closeSettings(); });

function openSettings(){
  reminderEnabledEl.checked = !!state.settings?.reminderEnabled;
  reminderTimeEl.value = state.settings?.reminderTime || "20:00";
  settingsBg.classList.add("show");
}
function closeSettings(){ settingsBg.classList.remove("show"); }
saveSettingsBtn.onclick = ()=>{
  state.settings.reminderEnabled = !!reminderEnabledEl.checked;
  state.settings.reminderTime = reminderTimeEl.value || "20:00";
  saveState();
  closeSettings();
  renderBanner();
  flashBanner("Instellingen opgeslagen ‚úÖ", "good", 1500);
};

/* ===========================
   EXPORT / IMPORT / RESET
=========================== */
exportBtn.onclick = ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `voornemens-export-${isoToday()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
};

importBtn.onclick = ()=>fileInput.click();
fileInput.onchange = async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const text = await file.text();
  try{
    const imported = JSON.parse(text);
    if(!imported || typeof imported !== "object") throw new Error("invalid");
    if(!Array.isArray(imported.goals) || typeof imported.days !== "object") throw new Error("shape");
    // normalize colors
    imported.goals = imported.goals.map((g, i)=>({
      id: String(g.id ?? ("g_" + i)),
      name: String(g.name ?? ("Voornemen " + (i+1))),
      color: String(g.color ?? getGoalColor(i))
    }));
    imported.settings ??= structuredClone(defaultState.settings);
    state = imported;
    saveState();
    renderAll();
    flashBanner("Import gelukt ‚úÖ", "good", 1800);
  }catch{
    alert("Import mislukt: dit bestand is geen geldige export van deze app.");
  }finally{
    fileInput.value = "";
  }
};

resetBtn.onclick = ()=>{
  if(!confirm("Alles resetten? Dit kan niet ongedaan worden gemaakt.")) return;
  state = structuredClone(defaultState);
  saveState();
  renderAll();
  flashBanner("Alles gereset.", "warn", 1500);
};

/* ===========================
   UI RENDERING
=========================== */
addGoalBtn.onclick = addGoal;
newGoalEl.addEventListener("keydown", (e)=>{ if(e.key === "Enter") addGoal(); });
saveNoteBtn.onclick = ()=>saveNoteForDay(datePickEl.value || isoToday());
rangeSelectEl.onchange = ()=>drawChart();

function renderDay(){
  const dateISO = datePickEl.value || isoToday();
  ensureDay(dateISO);

  // note
  dayNoteEl.value = state.days[dateISO].note || "";

  // goals list with scoring inputs
  goalsListEl.innerHTML = "";
  if(state.goals.length === 0){
    goalsListEl.innerHTML = `<div class="muted">Nog geen voornemens. Voeg er bovenaan √©√©n toe.</div>`;
    renderHeaderBadges();
    renderBanner();
    drawChart();
    renderAverages();
    return;
  }

  for(const g of state.goals){
    const score = state.days[dateISO]?.scores?.[g.id];
    const wrapper = document.createElement("div");
    wrapper.className = "goal";

    const left = document.createElement("div");
    left.className = "left";
    left.style.flex = "1";
    left.style.minWidth = "0";

    const nm = document.createElement("div");
    nm.className = "name";
    nm.innerHTML = `<span class="colorDot" style="background:${g.color}"></span> ${escHtml(g.name)}`;

    const meta = document.createElement("div");
    meta.className = "meta";

    const avg = calcAveragePercent(g.id);
    const avgTxt = (avg.pct == null) ? "‚Äî" : `${Math.round(avg.pct)}%`;
    const pillAvg = document.createElement("span");
    pillAvg.className = "pill";
    pillAvg.textContent = `Gem.: ${avgTxt}`;

    const pillCount = document.createElement("span");
    pillCount.className = "pill";
    pillCount.textContent = `${avg.count} dag(en)`;

    meta.appendChild(pillAvg);
    meta.appendChild(pillCount);

    left.appendChild(nm);
    left.appendChild(meta);

    const right = document.createElement("div");
    right.className = "row nowrap";
    right.style.flex = "0 0 auto";

    const input = document.createElement("input");
    input.className = "scoreInput";
    input.type = "number";
    input.min = "0";
    input.max = "10";
    input.step = "1";
    input.inputMode = "numeric";
    input.placeholder = "‚Äî";
    input.value = (score == null) ? "" : String(score);
    input.oninput = ()=>setScore(dateISO, g.id, input.value);

    const renameBtn = document.createElement("button");
    renameBtn.className = "ghost iconBtn";
    renameBtn.title = "Hernoem";
    renameBtn.textContent = "‚úèÔ∏è";
    renameBtn.onclick = ()=>{
      const n = prompt("Nieuwe naam:", g.name);
      if(n != null) renameGoal(g.id, n);
    };

    const delBtn = document.createElement("button");
    delBtn.className = "danger iconBtn";
    delBtn.title = "Verwijder";
    delBtn.textContent = "üóëÔ∏è";
    delBtn.onclick = ()=>{
      if(confirm(`"${g.name}" verwijderen?`)) removeGoal(g.id);
    };

    right.appendChild(input);
    right.appendChild(renameBtn);
    right.appendChild(delBtn);

    wrapper.appendChild(left);
    wrapper.appendChild(right);
    goalsListEl.appendChild(wrapper);
  }

  renderHeaderBadges();
  renderBanner();
  drawChart();
  renderAverages();
}

function renderAverages(){
  avgGridEl.innerHTML = "";
  if(state.goals.length === 0){
    avgGridEl.innerHTML = `<div class="muted">Voeg een voornemen toe om gemiddelden te zien.</div>`;
    return;
  }

  for(const g of state.goals){
    const { pct, count } = calcAveragePercent(g.id);
    const pctTxt = (pct == null) ? "‚Äî" : `${Math.round(pct)}%`;
    const item = document.createElement("div");
    item.className = "avgItem";
    item.innerHTML = `
      <div class="top">
        <div class="title"><span class="colorDot" style="background:${g.color}"></span> ${escHtml(g.name)}</div>
        <div class="pct">${pctTxt}</div>
      </div>
      <div class="sub">${count === 0 ? "Nog geen scores" : `${count} dag(en) meegenomen in gemiddelde`}</div>
    `;
    avgGridEl.appendChild(item);
  }
}

function renderLegend(){
  legendEl.innerHTML = "";
  if(state.goals.length === 0) return;
  for(const g of state.goals){
    const li = document.createElement("div");
    li.className = "legendItem";
    li.innerHTML = `<span class="colorDot" style="background:${g.color}"></span> ${escHtml(g.name)}`;
    legendEl.appendChild(li);
  }
}

function renderHeaderBadges(){
  const dateISO = datePickEl.value || isoToday();
  const t = isoToday();
  const isToday = dateISO === t;

  // today completion
  const comp = completionForDay(t);
  const compTxt = state.goals.length === 0 ? "‚Äî" : `${Math.round(comp*100)}%`;
  todayPill.textContent = `Vandaag: ${compTxt}`;

  // streak (count consecutive days with any score)
  const streak = calcStreak();
  streakPill.textContent = `Streak: ${streak} dag(en)`;
  streakPill.style.borderColor = streak >= 7 ? "rgba(81,227,164,.35)" : "rgba(255,255,255,.12)";

  // disable next if in future
  nextDayBtn.disabled = addDays(dateISO, +1) > t;
  nextDayBtn.style.opacity = nextDayBtn.disabled ? 0.5 : 1;
}

/* ===========================
   BANNERS & REMINDERS
=========================== */
let bannerTimer = null;

function flashBanner(text, type="warn", ms=1200){
  bannerEl.textContent = text;
  bannerEl.className = `banner show ${type}`;
  if(bannerTimer) clearTimeout(bannerTimer);
  bannerTimer = setTimeout(()=>{ renderBanner(); }, ms);
}

function renderBanner(){
  const t = isoToday();
  ensureDay(t);

  // main reminder banner logic: only when viewing today OR always? We'll show always but with clear context.
  const now = new Date();
  const [hh, mm] = String(state.settings.reminderTime || "20:00").split(":").map(Number);
  const trigger = new Date();
  trigger.setHours(hh || 20, mm || 0, 0, 0);

  const hasTodayScores = hasAnyScores(t);
  const remOn = !!state.settings.reminderEnabled;

  // Completion banner
  if(state.goals.length === 0){
    bannerEl.className = "banner show warn";
    bannerEl.innerHTML = `Voeg je eerste voornemen toe om te beginnen.`;
    return;
  }

  const c = completionForDay(t);
  const pct = Math.round(c * 100);
  let compType = (pct >= 80) ? "good" : (pct >= 40 ? "warn" : "bad");
  let compMsg = `Vandaag ingevuld: <b>${pct}%</b>.`;

  // Reminder
  if(remOn && !hasTodayScores && now >= trigger){
    bannerEl.className = "banner show warn";
    bannerEl.innerHTML = `‚è∞ Herinnering: je hebt vandaag (<b>${t}</b>) nog niets gescoord.`;
    return;
  }

  // Not today view: show a small info banner
  if((datePickEl.value || t) !== t){
    const view = datePickEl.value;
    const any = hasAnyScores(view);
    bannerEl.className = `banner show ${any ? "good" : "warn"}`;
    bannerEl.innerHTML = `Je kijkt naar <b>${view}</b>. ${any ? "Er staan scores op deze dag." : "Nog geen scores op deze dag."}`;
    return;
  }

  bannerEl.className = `banner show ${compType}`;
  bannerEl.innerHTML = compMsg;
}

/* ===========================
   CALCULATIONS
=========================== */
function hasAnyScores(dateISO){
  ensureDay(dateISO);
  const s = state.days[dateISO].scores || {};
  return Object.values(s).some(v => v != null);
}

function completionForDay(dateISO){
  if(state.goals.length === 0) return 0;
  ensureDay(dateISO);
  const scores = state.days[dateISO].scores || {};
  let filled = 0;
  for(const g of state.goals){
    if(scores[g.id] != null) filled++;
  }
  return filled / state.goals.length; // 0..1
}

function calcAveragePercent(goalId){
  let sum = 0, count = 0;
  for(const d of Object.keys(state.days)){
    const v = state.days[d]?.scores?.[goalId];
    if(v == null) continue;
    sum += Number(v);
    count++;
  }
  if(!count) return { pct: null, count: 0 };
  const avg = sum / count;           // 0..10
  return { pct: (avg/10)*100, count };
}

function calcStreak(){
  // consecutive days up to today where there is at least one score that day
  const t = isoToday();
  let streak = 0;
  for(let i=0; i<5000; i++){
    const d = addDays(t, -i);
    if(hasAnyScores(d)) streak++;
    else break;
  }
  return streak;
}

/* ===========================
   SIMPLE CHART (NO LIBS)
   - draws multi-line chart with gaps for null values
   - tooltips on tap/click
=========================== */
const canvas = el("chart");
const ctx = canvas.getContext("2d");
let tooltip = { show:false, x:0, y:0, lines:[], date:"" };

function getRangeDates(){
  const mode = rangeSelectEl.value;
  const todayISO = isoToday();

  // all dates that exist:
  const existing = Object.keys(state.days).sort();
  if(mode === "all"){
    // ensure we show at least last 1 if empty
    return existing.length ? existing : [todayISO];
  }
  const days = Number(mode);
  const start = addDays(todayISO, -(days-1));
  const res = [];
  for(let i=0; i<days; i++) res.push(addDays(start, i));
  return res;
}

function resizeCanvas(){
  // CSS size to real pixels for sharpness
  const rect = canvas.getBoundingClientRect();
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  canvas.width = Math.floor(rect.width * dpr);
  canvas.height = Math.floor(rect.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

function drawChart(){
  renderLegend();
  resizeCanvas();

  const W = canvas.getBoundingClientRect().width;
  const H = canvas.getBoundingClientRect().height;

  // padding for axes labels
  const padL = 44, padR = 14, padT = 16, padB = 34;
  const plotW = W - padL - padR;
  const plotH = H - padT - padB;

  // background
  ctx.clearRect(0,0,W,H);

  // if no goals
  if(state.goals.length === 0){
    ctx.fillStyle = "rgba(234,240,255,.85)";
    ctx.font = "600 14px system-ui,-apple-system,Segoe UI,Roboto,Arial";
    ctx.fillText("Voeg links een voornemen toe om de grafiek te zien.", 18, 36);
    return;
  }

  // dates
  const dates = getRangeDates();
  // build series arrays
  const series = state.goals.map(g => ({
    goal: g,
    values: dates.map(d => {
      const v = state.days[d]?.scores?.[g.id];
      return (v == null ? null : Number(v));
    })
  }));

  // grid lines
  ctx.strokeStyle = "rgba(255,255,255,.08)";
  ctx.lineWidth = 1;

  // horizontal grid at 0,2,4,6,8,10
  ctx.font = "12px system-ui,-apple-system,Segoe UI,Roboto,Arial";
  ctx.fillStyle = "rgba(168,182,214,.95)";
  for(let i=0;i<=5;i++){
    const yVal = i*2;
    const y = padT + plotH - (yVal/10)*plotH;
    ctx.beginPath();
    ctx.moveTo(padL, y);
    ctx.lineTo(padL+plotW, y);
    ctx.stroke();
    ctx.fillText(String(yVal), 14, y+4);
  }

  // x ticks (max 6)
  const tickCount = Math.min(6, dates.length);
  for(let i=0;i<tickCount;i++){
    const idx = Math.round(i*(dates.length-1)/(tickCount-1 || 1));
    const x = padL + (idx/(dates.length-1 || 1))*plotW;
    ctx.beginPath();
    ctx.moveTo(x, padT);
    ctx.lineTo(x, padT+plotH);
    ctx.stroke();

    const label = dates[idx].slice(5); // MM-DD
    ctx.fillText(label, x-18, padT+plotH+22);
  }

  // helper: map point
  const xOf = (idx)=> padL + (idx/(dates.length-1 || 1))*plotW;
  const yOf = (v)=> padT + plotH - (v/10)*plotH;

  // draw each series
  for(const s of series){
    ctx.strokeStyle = s.goal.color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    let started = false;

    for(let i=0;i<dates.length;i++){
      const v = s.values[i];
      if(v == null){
        started = false;
        continue;
      }
      const x = xOf(i), y = yOf(v);
      if(!started){
        ctx.moveTo(x,y);
        started = true;
      }else{
        ctx.lineTo(x,y);
      }
    }
    ctx.stroke();

    // points
    ctx.fillStyle = s.goal.color;
    for(let i=0;i<dates.length;i++){
      const v = s.values[i];
      if(v == null) continue;
      const x = xOf(i), y = yOf(v);
      ctx.beginPath();
      ctx.arc(x,y, 3, 0, Math.PI*2);
      ctx.fill();
    }
  }

  // tooltip (if active)
  if(tooltip.show){
    const boxPad = 10;
    const lineH = 16;
    const maxLines = Math.min(tooltip.lines.length, 6);
    const w = 260;
    const h = boxPad*2 + lineH*(maxLines + 1);

    let bx = tooltip.x + 12;
    let by = tooltip.y - h - 12;
    if(bx + w > W) bx = W - w - 12;
    if(by < 8) by = 8;

    // box
    ctx.fillStyle = "rgba(10,14,28,.92)";
    ctx.strokeStyle = "rgba(255,255,255,.14)";
    ctx.lineWidth = 1;
    roundRect(ctx, bx, by, w, h, 12, true, true);

    ctx.fillStyle = "rgba(234,240,255,.95)";
    ctx.font = "800 12px system-ui,-apple-system,Segoe UI,Roboto,Arial";
    ctx.fillText(tooltip.date, bx+boxPad, by+boxPad+11);

    ctx.font = "12px system-ui,-apple-system,Segoe UI,Roboto,Arial";
    for(let i=0;i<maxLines;i++){
      const it = tooltip.lines[i];
      const y = by+boxPad+11 + lineH*(i+1);
      // color dot
      ctx.fillStyle = it.color;
      ctx.beginPath();
      ctx.arc(bx+boxPad+3, y-3, 4, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = "rgba(168,182,214,.98)";
      ctx.fillText(`${it.name}: `, bx+boxPad+14, y);
      ctx.fillStyle = "rgba(234,240,255,.98)";
      ctx.fillText(String(it.value), bx+boxPad+14 + ctx.measureText(`${it.name}: `).width, y);
    }
  }

  // Save hitmap for tooltips
  buildHitMap(dates, series, padL, padT, plotW, plotH);

  function roundRect(ctx, x, y, w, h, r, fill, stroke){
    if(w < 2*r) r = w/2;
    if(h < 2*r) r = h/2;
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
    if(fill) ctx.fill();
    if(stroke) ctx.stroke();
  }
}

let hitMap = null;
function buildHitMap(dates, series, padL, padT, plotW, plotH){
  // store x positions and per-goal values at each date
  const xs = dates.map((_, idx) => padL + (idx/(dates.length-1 || 1))*plotW);
  hitMap = { dates, xs, series };
}

function onPointer(e){
  if(!hitMap || state.goals.length === 0) return;
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX ?? e.touches?.[0]?.clientX) - rect.left;
  const y = (e.clientY ?? e.touches?.[0]?.clientY) - rect.top;

  // find nearest x
  let best = 0;
  let bestDist = Infinity;
  for(let i=0;i<hitMap.xs.length;i++){
    const d = Math.abs(hitMap.xs[i] - x);
    if(d < bestDist){ bestDist = d; best = i; }
  }
  if(bestDist > 18){ tooltip.show = false; drawChart(); return; }

  const date = hitMap.dates[best];
  const lines = [];
  for(const s of hitMap.series){
    const v = s.values?.[best];
    if(v == null) continue;
    lines.push({ name: s.goal.name, value: v, color: s.goal.color });
  }
  if(lines.length === 0){ tooltip.show = false; drawChart(); return; }

  tooltip = { show:true, x, y, date, lines };
  drawChart();
}

canvas.addEventListener("mousemove", onPointer);
canvas.addEventListener("touchstart", onPointer, {passive:true});
canvas.addEventListener("touchmove", onPointer, {passive:true});
canvas.addEventListener("mouseleave", ()=>{ tooltip.show=false; drawChart(); });

window.addEventListener("resize", ()=>drawChart());

/* ===========================
   STARTUP
=========================== */
function renderAll(){
  // ensure settings
  state.settings ??= structuredClone(defaultState.settings);

  // ensure goal colors
  state.goals = (state.goals || []).map((g,i)=>({
    id: String(g.id),
    name: String(g.name ?? `Voornemen ${i+1}`),
    color: String(g.color ?? getGoalColor(i))
  }));

  // prevent selecting future dates easily
  datePickEl.max = isoToday();

  renderDay();
}

renderAll();

/* ===========================
   In-app reminder check:
   - on visibility change (coming back), re-render banner
=========================== */
document.addEventListener("visibilitychange", ()=>{
  if(document.visibilityState === "visible"){
    renderHeaderBadges();
    renderBanner();
  }
});
</script>
</body>
</html>
